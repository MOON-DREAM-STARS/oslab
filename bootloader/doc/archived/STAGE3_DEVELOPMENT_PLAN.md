# Stage 3 开发计划

## 总览
基于Stage 2的成功基础，Stage 3将实现完整的xv6内核启动和系统集成。

## 阶段3.1: 性能优化和完整加载

### 目标
移除Stage 2的临时限制，实现完整的内核加载

### 任务清单

#### 3.1.1 内存操作性能优化
- [ ] **分析性能瓶颈**
  - 识别大内存复制超时的根本原因
  - 测试不同的内存复制策略
  - 优化编译器设置（-O2 vs -O3 vs -Os）

- [ ] **实现高效内存复制**
  - 使用RISC-V优化的内存复制例程
  - 实现DMA风格的批量传输
  - 添加中断驱动的异步复制

- [ ] **优化BSS段清零**
  - 使用64位对齐的清零操作
  - 实现块状清零（避免逐字节操作）
  - 添加进度指示器防止超时假象

#### 3.1.2 完整ELF加载验证
- [ ] **移除大小限制**
  ```c
  // 移除这些限制：
  if (copy_size > 4096) copy_size = 4096;  // 删除
  if (bss_size > 1024) bss_size = 1024;    // 删除
  ```

- [ ] **验证完整内核**
  - 测试完整的35KB代码段加载
  - 验证完整的103KB BSS段清零
  - 确认内核入口点正确性

### 时间估计: 1-2天

## 阶段3.2: 内核启动接口

### 目标
建立引导程序和内核之间的标准接口

### 任务清单

#### 3.2.1 引导信息结构
- [ ] **设计引导信息结构**
  ```c
  struct boot_info {
      uint64 memory_size;      // 系统内存大小
      uint64 kernel_base;      // 内核加载地址
      uint64 kernel_size;      // 内核大小
      uint64 initrd_base;      // 初始RAM磁盘地址（如果有）
      uint64 initrd_size;      // 初始RAM磁盘大小
      uint64 cmdline_ptr;      // 内核命令行参数
      uint64 device_tree_ptr;  // 设备树地址（可选）
  };
  ```

- [ ] **传递引导参数**
  - 在跳转到内核前设置寄存器
  - 遵循RISC-V引导约定（a0, a1寄存器）
  - 实现引导信息的内存放置

#### 3.2.2 内核修改适配
- [ ] **分析xv6内核入口**
  - 检查`kernel/entry.S`和`kernel/main.c`
  - 确定内核期望的启动状态
  - 验证内存布局兼容性

- [ ] **修改内核启动代码**
  - 适配引导信息接收
  - 移除硬编码的硬件假设
  - 添加引导程序兼容性检查

### 时间估计: 2-3天

## 阶段3.3: 高级特性

### 目标
实现高级引导特性和完整系统集成

### 任务清单

#### 3.3.1 内存映射和保护
- [ ] **完善内存布局**
  ```
  0x80000000-0x80010000  : Stage 2引导程序（64KB）
  0x80010000-0x80020000  : virtio队列和缓冲区（64KB）  
  0x80020000-0x80080000  : 内核代码和数据（384KB）
  0x80080000-0x88000000  : 内核堆和用户空间（128MB-512KB）
  ```

- [ ] **实现内存保护**
  - 设置页表保护引导程序内存
  - 防止内核覆盖引导数据
  - 实现内存区域隔离

#### 3.3.2 设备树和硬件抽象
- [ ] **生成设备树**
  - 描述QEMU virt机器的硬件布局
  - 包含内存映射、中断和设备信息
  - 传递给内核进行硬件初始化

- [ ] **硬件抽象层**
  - 提供统一的硬件访问接口
  - 支持不同的RISC-V平台
  - 实现可插拔的驱动程序架构

#### 3.3.3 错误处理和恢复
- [ ] **强化错误处理**
  - 实现详细的错误代码系统
  - 添加内核加载失败的回退机制
  - 提供调试和诊断信息

- [ ] **实现引导恢复**
  - 支持多内核引导选项
  - 实现引导菜单（可选）
  - 添加安全引导检查

### 时间估计: 3-4天

## 阶段3.4: 完整系统验证

### 目标
验证完整的xv6系统启动到用户shell

### 任务清单

#### 3.4.1 端到端测试
- [ ] **完整引导测试**
  - 从QEMU启动到xv6 shell
  - 验证所有用户程序正常运行
  - 测试文件系统和I/O操作

- [ ] **性能基准测试**
  - 测量引导时间
  - 比较与原始xv6的性能
  - 优化关键路径

#### 3.4.2 文档和交付
- [ ] **完善技术文档**
  - 详细的引导流程说明
  - virtio驱动程序文档
  - 故障排除指南

- [ ] **代码清理**
  - 移除调试代码和临时限制
  - 统一代码风格和注释
  - 优化编译输出

### 时间估计: 1-2天

## 总时间估计: 7-11天

## 下一步行动

基于用户的指示"Continue to iterate?"，建议的下一步：

### 立即任务（今天）
1. **移除性能限制** - 恢复完整的内存复制和BSS清除
2. **验证内核启动** - 确认内核能够完全启动到初始化完成

### 短期目标（本周）
1. **完成Stage 3.1** - 性能优化和完整加载
2. **开始Stage 3.2** - 内核启动接口设计

### 中期目标（下周）
1. **完成Stage 3.2和3.3** - 高级特性实现
2. **开始Stage 3.4** - 系统验证

这个计划确保了一个稳定的增量开发过程，每个阶段都有明确的可测试目标。
